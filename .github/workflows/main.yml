name: release-dmg
on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Build app (Release, unsigned)
        run: |
          xcodebuild \
            -scheme "AutoSort" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Prepare DMG contents
        run: |
          mkdir -p "dmg-contents"
          cp -R "build/Build/Products/Release/AutoSort.app" "dmg-contents/"

      - name: Create DMG
        run: |
          create-dmg \
            --volname "AutoSort" \
            --window-pos 710 390 \
            --window-size 500 300 \
            --icon-size 160 \
            --icon "AutoSort.app" 130 120 \
            --app-drop-link 370 120 \
            "AutoSort.dmg" \
            "dmg-contents/"

      - name: Publish Release
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
          gh release create "${GITHUB_REF_NAME}" "AutoSort.dmg" \
            --title "${GITHUB_REF_NAME}" \
            --notes "AutoSort ${GITHUB_REF_NAME}"
